<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Ricoh Theta in VR</title>
    <meta name="description" content="360 Video with A-Frame">
    <link rel="stylesheet" type="text/css" href="/assets/css/flat_buttons.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/global.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/custom.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/nativize.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/side_menu.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/aframe.min.js"></script>
    <script type="text/javascript" src="/assets/js/digest-fetch-src.js"></script>
    <script type="text/javascript" src="/assets/js/md5_backup.js"></script>
    <script type="text/javascript" src="/assets/js/digestAuthRequest.js"></script>
    <script type="text/javascript" src="/assets/js/aframe_components.js"></script>
    <script type="text/javascript" src="/assets/js/ricoh_api.js"></script>

</head>

<body>
    <!-- A-Frame scene populated with Ricoh Theta VR stream -->
    <a-scene>
        <a-sky id="preview_image" src="/assets/img/42341252701_f4de75cdf4_o.jpg" 
            refresh-event="trigger_event: new_frame_loaded"></a-sky>
    </a-scene>

    <!-- Side menu -->
    <span id="menu_open_btn" onclick="openSideMenu()">&#9776;</span>
    <div id="side_menu">
        <a href="javascript:void(0)" id="menu_close_btn" onclick="closeSideMenu()">&times;</a>
        <div class="setting_container">
            <a class="setting_title" href="#">Resolution</a>
            <div class="custom_select" id="setting_theta_resolution">
                <select id="setting_theta_resolution_selector">
                    <option value="1920_960">1920x960</option>
                    <option value="1024_512">1024x512</option>
                    <option value="640_320">640x320</option>
                </select>
            </div>
        </div>

        <div class="setting_container">
            <a class="setting_title" href="#">Framerate</a>
            <div class="custom_select">
                <select id="setting_theta_fps">
                    <!-- TODO: limit these options based on the resolution selected -->
                    <option value="8">8 FPS</option>
                    <option value="30">30 FPS</option>
                </select>
            </div>
        </div>
        
        <div class="setting_container">
            <a class="setting_title" href="#">Ricoh Theta IP</a>
            <input type="text" class="custom_text_input" id="setting_theta_ip" value="192.168.1.5">
        </div>
        
        <div class="setting_container">
            <a class="setting_title" href="#">Ricoh Theta Username</a>
            <input type="text" class="custom_text_input" id="setting_theta_username" value="THETAYL00164391">
        </div>
        
        <div class="setting_container">
            <a class="setting_title" href="#">Ricoh Theta Password</a>
            <input type="text" class="custom_text_input" id="setting_theta_password" value="00164391">
        </div>
        
        <div class="setting_container">
            <a class="setting_title" href="#">Record Locally</a>
            <label class="custom_checkbox_container">Enable local recording
                <input type="checkbox" id="record_locally_checkbox" checked="checked">
                <span class="checkmark"></span>
            </label>
        </div>
        
        <div class="setting_container">
            <a class="setting_title" href="#">Local Storage Directory</a>
            <label id="setting_download_dir" class="custom_dir_input_container">Select a directory...
                <input type="file" id="record_dir_field" class="custom_dir_input" name="setting_download_dir" 
                    onchange="selectFolder(event)" webkitdirectory 
                    mozdirectory msdirectory odirectory directory multiple />
                <span class="custom_file_btn fa fa-folder-open"></span>
            </label>
        </div>

        <button id="apply_settings_btn" class="btn btn-square btn-lg btn-filled-blue"
            onclick="saveAndApplySettings()">Apply</button>
    </div>

    <!--
    <div id="theta_control_panel" style="position: absolute; top:0px; left:0px; z-index:1000">
        <p>Ricoh Theta Control Panel</p>
        <button onclick="setThetaLivePreview(1920,960,8)">Set Live Preview to 1920x960 @ 8 FPS</button>
        <button onclick="setThetaLivePreview(640,320,8)">Set Live Preview to 620x320 @ 8 FPS</button>
        <button onclick="setThetaLivePreview(640,320,30)">Set Live Preview to 640x320 @ 30 FPS</button>
        <button onclick="setThetaLivePreview(1024,512,8)">Set Live Preview to 1024x512 @ 8 FPS</button>
        <button onclick="setThetaLivePreview(1024,512,30)">Set Live Preview to 1024x512 @ 30 FPS</button>
        <button onclick="getThetaInfo()">Fetch Theta Info</button>
        <button onclick="getThetaState()">Fetch Theta State</button>
        <button onclick="setThetaNeverSleep()">Set Theta Never Sleep</button>
        <button onclick="getThetaLivePreview()">Get Theta Live Preview</button>
    </div>
    -->
    <script>
        /* ======================= */
        /* Apply settings function */
        /* ======================= */
        /* 
         * Saves the settings, and then applies them using the Ricoh API.
         *
         * On success / failure, a message should pop up in a message queue on
         * the side menu.
         */
        function saveAndApplySettings() {
            /* Save the new settings */
            // Get the new settings
            var new_theta_ip = document.getElementById("setting_theta_ip").value;
            var new_theta_user = document.getElementById("setting_theta_username").value;
            var new_theta_pass = document.getElementById("setting_theta_password").value;
            var new_theta_res_x = document.getElementById("setting_theta_resolution_selector").
                value.split("_")[0];
            var new_theta_res_y = document.getElementById("setting_theta_resolution_selector").
                value.split("_")[1];
            var new_theta_fps = document.getElementById("setting_theta_fps").value;
            var new_record = document.getElementById("record_locally_checkbox").checked;
            var new_record_dir = document.getElementById("record_dir_field").value; // TODO: figure this out

            // Verify res and fps are valid combo
            if (new_theta_res_x == "1920" && new_theta_res_y == "960" 
                && new_theta_fps == "30") {
                console.log("Invalid FPS and resolution combo: " + 
                    new_theta_res_x + "x" + new_theta_res_y + " @ " + new_theta_fps + 
                    " FPS");
                return;
            }

            // Save the settings
            settings.theta_ip = new_theta_ip;
            settings.theta_user = new_theta_user;
            settings.theta_pass = new_theta_pass;
            settings.theta_res_x = parseInt(new_theta_res_x);
            settings.theta_res_y = parseInt(new_theta_res_y);
            settings.theta_fps = parseInt(new_theta_fps);
            settings.record_locally = new_record;
            settings.record_dir = new_record_dir;


            /* Apply the settings using the Ricoh API */
            // verify IP
            var valid_ip = verifyThetaIp(settings.theta_ip);
            console.log("Valid IP: " + valid_ip);    

            // verify username / pass
            var valid_login = verifyThetaLogin(settings.theta_user, settings.theta_pass);
            console.log("Valid Login: " + valid_login);

            // set never sleep
            // set livepreview info
            

            /* Tell user success / failure */
        }

        /* ==================================== */
        /* Slide menu controls                  */
        /* ==================================== */
        /* Opens the side menu */
        function openSideMenu() {
            document.getElementById("side_menu").style.width = "300px";
        }

        /* Closes the side menu */
        function closeSideMenu() {
            document.getElementById("side_menu").style.width = "0";
        }

        /* ==================================== */
        /* Code for custom dropdown select menu */
        /* ==================================== */
        var selOptionIndex; // index of the selected option in the <select> element
        var selElmnt;       // <select> element currently being styled
        var x;              // list of custom <select> elements to be styled
        var i;              // index of the custom <select> element in x
        var j;              // index of the option in the current custom <select> element
        var a, b, c;        // custom divs used to create each option
        /* On load look for any elements with the class "custom_select" and style them */
        x = document.getElementsByClassName("custom_select");
        for (i = 0; i < x.length; i++) {
            selElmnt = x[i].getElementsByTagName("select")[0];
            selOptionIndex = selElmnt.options.selectedIndex;

            /* For each element, create a new DIV that will act as the selected item: */
            a = document.createElement("DIV");
            a.setAttribute("class", "select_selected");
            a.innerHTML = selElmnt.options[selElmnt.selectedIndex].innerHTML;
            x[i].appendChild(a);

            /* For each element, create a new DIV that will contain the option list: */
            b = document.createElement("DIV");
            b.setAttribute("class", "select_items select_hide");
            for (j = 0; j < selElmnt.length; j++) {
                /* For each option in the original select element,
                create a new DIV that will act as an option item: */
                c = document.createElement("DIV");
                c.innerHTML = selElmnt.options[j].innerHTML;
                
                /* Shim for setting the color for the selected option on load before an
                   option is actually clicked */
                if (selOptionIndex == j) {
                    c.setAttribute("class", "same_as_selected");
                }

                /* Bind select function for when an option is clicked */
                c.addEventListener("click", function(e) {
                    /* When an item is clicked, update the original select box,
                    and the selected item: */
                    var y, i, k, s, h;
                    s = this.parentNode.parentNode.getElementsByTagName("select")[0];
                    h = this.parentNode.previousSibling;
                    for (i = 0; i < s.length; i++) {
                        if (s.options[i].innerHTML == this.innerHTML) {
                            s.selectedIndex = i;
                            h.innerHTML = this.innerHTML;
                            y = this.parentNode.getElementsByClassName("same_as_selected");
                            for (k = 0; k < y.length; k++) {
                                y[k].removeAttribute("class");
                            }
                            this.setAttribute("class", "same_as_selected");
                            break;
                        }
                    }
                    h.click();
                });
                
                b.appendChild(c);
            }

            x[i].appendChild(b);
            a.addEventListener("click", function(e) {
                /* When the select box is clicked, close any other select boxes,
                and open/close the current select box: */
                e.stopPropagation();
                closeAllSelect(this);
                this.nextSibling.classList.toggle("select_hide");
                this.classList.toggle("select_arrow_active");
            });
        }

        function closeAllSelect(elmnt) {
            /* A function that will close all select boxes in the document,
            except the current select box: */
            var x, y, i, arrNo = [];
            x = document.getElementsByClassName("select_items");
            y = document.getElementsByClassName("select_selected");
            for (i = 0; i < y.length; i++) {
                if (elmnt == y[i]) {
                    arrNo.push(i)
                } else {
                    y[i].classList.remove("select_arrow_active");
                }
            }

            for (i = 0; i < x.length; i++) {
                if (arrNo.indexOf(i)) {
                    x[i].classList.add("select_hide");
                }
            }
        }

        /* If the user clicks anywhere outside the select box,
        then close all select boxes: */
        document.addEventListener("click", closeAllSelect);
        
        /* ================================================ */
        /* Selects a folder and updates the dir picker text */
        /* ================================================ */
        function selectFolder(e) {
            // TODO: get full path
            var iconHtml = "\n<input type=\"file\" class=\"custom_dir_input\" name=\"setting_download_dir\" onchange=\"selectFolder(event)\" webkitdirectory=\"\" mozdirectory=\"\" msdirectory=\"\" odirectory=\"\" directory=\"\" multiple=\"\">\n<span class=\"custom_file_btn fa fa-folder-open\"></span>\n"
            var theFiles = e.target.files;
            var relativePath = theFiles[0].webkitRelativePath;
            var folder = relativePath.split("/");
            var folderName = folder[0];
            document.getElementById("setting_download_dir").innerHTML = 
                folderName + iconHtml;
        }

    </script>
</body>
</html>
