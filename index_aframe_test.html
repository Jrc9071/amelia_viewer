<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Ricoh Theta V Livestream</title>
  <meta name="description" content="360 Video â€” A-Frame">
  <!-- NG
  <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
   -->
  <!-- OK
  <script src="https://aframe.io/releases/0.7.1/aframe.min.js"></script>
  // 0.6.1, 0.7.0, 0.7.1 OK (0.7.2, 0.7.5 NO exist)
  -->
  <script src="https://aframe.io/releases/0.7.1/aframe.min.js"></script>
  <script>
        // Hide the wait message on the player
        function hideWaitMessage() {
            const element = document.getElementById("wait_massage");
            element.style.display = 'none';
        }
        
        // Attach the MediaStream to the a-frame videosphere
        function attachVideo(stream) {
            const videoElement = document.getElementById("video1");
            videoElement.srcObject = stream;
            videoElement.play();
            console.info("remote media start");
        }

        // Set the stream parameters for the Ricoh

        // Convert the received stream to a MediaStream?

        // Fetch the live preview stream from the Ricoh and display it
        function fetchAndSetupStream() {
            // TODO: set stream params
            // TODO: fetch the preview stream
            // TODO: pipe the preview stream to attachVideo()
        }

    </script>
    <script>
        // ===========================================
        // Register the aframe components and elements
        // ===========================================
        AFRAME.registerComponent('play-on-window-click', {
            init: function () {
                this.onClick = this.onClick.bind(this);
            },
            play: function () {
                window.addEventListener('click', this.onClick);
            },
            pause: function () {
                window.removeEventListener('click', this.onClick);
            },
            onClick: function (evt) {
                hideWaitMessage();
                fetchAndSetupStream();
            }
        });

        AFRAME.registerComponent('hide-once-playing', {
            schema: {type: 'selector'},
            init: function () {
                this.onPlaying = this.onPlaying.bind(this);
                this.onPause = this.onPause.bind(this);
            },
            play: function () {
                if (this.data) {
                    this.data.addEventListener('playing', this.onPlaying);
                    this.data.addEventListener('pause', this.onPause);
                }
            },
            pause: function () {
                if (this.data) {
                    this.data.removeEventListener('playing', this.onPlaying);
                    this.data.removeEventListener('pause', this.onPause);
                }
            },
            onPlaying: function (evt) {
                this.el.setAttribute('visible', false);
            },
            onPause: function (evt) {
                this.el.setAttribute('visible', true);
            }
        });
  </script>
</head>

<body>
  <div id="wait_massage">Please wait for loading ...</div>
  <a-scene>
    <a-assets>
      <video id="video1" 
             src="http://192.168.1.27:9001/c60f1c5b-0c39-4812-9e96-186fbed1d774" 
          autoplay loop crossorigin="anonymous" playsinline webkit-playsinline></video>
    </a-assets>
    <a-videosphere src="#video1" rotation="0 180 0" play-on-window-click></a-videosphere>

    <a-camera user-height="0" wasd-controls-enabled="false" arrow-key-rotation>
      <!-- Text element for display messaging.  Hide once video is playing. -->
      <a-entity id="msg" position="0 -0.3 -1.5" text="align:center; 
              width:3;
              wrapCount:100;
              color: #FF8080;
              value:Please click window to start 360 video streaming."
              hide-once-playing="#video1">
      </a-entity>
    </a-camera>   

  </a-scene>
</body>
</html>

